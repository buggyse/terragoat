name: Gitleaks Scan for Organization Repositories

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Schedule daily scans (adjust as needed)

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install Gitleaks
        run: |
          wget https://github.com/zricethezav/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_arm64.tar.gz
          tar -zxvf gitleaks_8.18.0_linux_arm64.tar.gz
          chmod +x gitleaks
          mv gitleaks /usr/local/bin/

      - name: Get Organization Repositories
        run: |
          ORG_NAME="bughuntermarle"
          PAGE=1
          PER_PAGE=100
          REPO_LIST=""
          while true; do
            RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/orgs/$ORG_NAME/repos?page=$PAGE&per_page=$PER_PAGE")
            REPO_URLS=$(echo "$RESPONSE" | jq -r '.[].clone_url')
            if [ -z "$REPO_URLS" ]; then
              break
            fi
            REPO_LIST="$REPO_LIST$REPO_URLS\n"
            PAGE=$((PAGE+1))
          done
          echo -e "$REPO_LIST" > org_repo_list.txt

      - name: Run Gitleaks Scan
        run: |
          while IFS= read -r repo_url; do
            repo_name=$(basename $repo_url)
            echo "Scanning repository: $repo_name"
            git clone --depth 1 --quiet --single-branch --branch main "$repo_url" "repo-$repo_name"
            gitleaks --path="repo-$repo_name" --verbose
            rm -rf "repo-$repo_name"
          done < org_repo_list.txt
