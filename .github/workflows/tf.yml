name: tfsec PR Commenter

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  tfsec:
    name: tfsec PR commenter
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Run Tfsec
        uses: aquasecurity/tfsec-action@v1.0.3

      - name: Get tfsec results
        id: tfsec-results
        run: |
          tfsec_result=$(curl -s -X POST \
            -H "Content-type: application/json" \
            --data '{
              "repository": "'"$GITHUB_REPOSITORY"'",
              "pull_request_number": "'"$GITHUB_EVENT_NUMBER"'",
              "tfsec_results": "'"$(cat tfsec_results.json)"'"
            }' \
            $SLACK_WEBHOOK_URL)
          echo "tfsec_result=$tfsec_result" >> $GITHUB_ENV
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Comment on PR
        if: steps.tfsec-results.outputs.tfsec_result == 'success'
        run: |
          curl -X POST -H "Content-type: application/json" --data '{
            "text": "Terraform security scan passed for this PR. No issues found.",
            "channel": "#general",
            "username": "GitHub Actions"
          }' $SLACK_WEBHOOK_URL

      - name: Comment on PR with tfsec results
        if: steps.tfsec-results.outputs.tfsec_result != 'success'
        run: |
          curl -X POST -H "Content-type: application/json" --data '{
            "text": "Terraform security issues found in this PR. Check the tfsec results below:\n```'"$(cat tfsec_results.json)"'```",
            "channel": "#general",
            "username": "GitHub Actions"
          }' $SLACK_WEBHOOK_URL
